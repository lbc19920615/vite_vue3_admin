import{B as e,q as t,P as a,V as l,k as o,n,o as s,p as r,a6 as i,a7 as p}from"./index.872417fc.js";import"./ext.943b90d0.js";import{u as m}from"./router.08179b34.js";import{a as c}from"./form.e330999e.js";import{a as d,x as f,t as u,r as g,e as _,h,w as y,g as v,A as b,d as w,p as k,as as C,a7 as E,f as T,B as x,F as R,C as M,k as N}from"./vendor.70e2a6e0.js";import"http://192.168.1.67:7002/public/expose/main.js";import"http://192.168.1.67:7002/public/expose/ext.js";import"./CommonRender.d6009dc7.js";import"./nodes.a56b7126.js";const P={name:"WechatExportDialog",components:{ZEasyModal:e,AutoHttpCom:t},props:{page:null},setup(e,t){let a=ZY.JSON5,l="wechat-export__"+ZY.rid(6),o=null;e.page.setProcessEventHandler(l,{handler(e,t){console.log(e,t)}}),d((()=>{e.page.removeProcessEventHandler(l)}));let n=c(l,{def:{type:"object",ui:{attrs:[["label-width","100px"]]},properties:{libPath:{type:"string",ui:{label:"zform位置",widgetConfig:{}}}}},computed:{},partName:"form2",defaultVal:{form2:{}}});return{state:f({is:l,inited:!1,def:a.stringify(n)}),getRef:function(e){o=e},submit:function(e,a){let{partName:l,parts:o}=e,n=u(o[l].getModel());console.log("submit",n,e),t.emit("submit",{model:n})},show:function(){o.openModal()}}}},Z=b("确定");function S({handleProp:e}={}){let t=ZY.lodash;function a(l={},{obj:o={},path:n=[],ext:s={}}={}){if("object"===l.type)t.each(l.properties,(function(e,t){a(e,{obj:o,path:n.concat(["properties",t]),ext:s})}));else if("array"===l.type);else{let t=ZY.getObjPathFromPathArr(n);e({obj:o,s_path:t,path:n,ext:s})}}return{run:function(e={},t={}){let l={};return a(e,{obj:l,path:[],ext:t}),l}}}P.render=function(e,t,a,l,o,n){const s=g("el-button"),r=g("auto-http-com"),i=g("z-easy-modal");return _(),h(i,{title:"导出选项",ref:l.getRef,"button-attr":{style:"display: none;"},"model-attr":{width:"60vw"}},{default:y((()=>[v(r,{def:l.state.def,page:a.page,is:l.state.is},{form_afterend:y((e=>[v(s,{onClick:t=>l.submit(e,t)},{default:y((()=>[Z])),_:2},1032,["onClick"])])),_:1},8,["def","page","is"])])),_:1},512)};const A={name:"Vue2ExportDialog",components:{ZEasyModal:e,AutoHttpCom:t},props:{page:null},setup(e,t){let a=ZY.JSON5,l="vue2-export__"+ZY.rid(6),o=null;e.page.setProcessEventHandler(l,{handler(e,t){console.log(e,t)}}),d((()=>{e.page.removeProcessEventHandler(l)}));let n=c(l,{def:{type:"object",ui:{attrs:[["label-width","100px"]]},properties:{libPath:{type:"string",ui:{label:"zform位置",widgetConfig:{}}}}},computed:{},partName:"form2",defaultVal:{form2:{}}});return{state:f({is:l,inited:!1,def:a.stringify(n)}),getRef:function(e){o=e},submit:function(e,a){let{partName:l,parts:o}=e,n=u(o[l].getModel());console.log("submit",n,e),t.emit("submit",{model:n})},show:function(){o.openModal()}}}},Y=b("确定");A.render=function(e,t,a,l,o,n){const s=g("el-button"),r=g("auto-http-com"),i=g("z-easy-modal");return _(),h(i,{title:"导出选项",ref:l.getRef,"button-attr":{style:"display: none;"},"model-attr":{width:"60vw"}},{default:y((()=>[v(r,{def:l.state.def,page:a.page,is:l.state.is},{form_afterend:y((e=>[v(s,{onClick:t=>l.submit(e,t)},{default:y((()=>[Y])),_:2},1032,["onClick"])])),_:1},8,["def","page","is"])])),_:1},512)};globalThis.downloadFiles=function(e,t,a=ZY_EXT.FS.fileSave){return new Promise((l=>{if(globalThis.JSZip){let o=new globalThis.JSZip;t.forEach(((e,t)=>{o.file(t,e)})),console.log(e),o.generateAsync({type:"blob"}).then((function(t){a(t,{fileName:e}),l()}))}}))};const j=w({mixins:[a],data:()=>({}),components:{Vue2ExportDialog:A,WechatExportDialog:P},setup(e,t){var a;let c,d=null;globalThis.importScripts(location.origin+"/server1/message.js").then((e=>{c=e,window.parent.postMessage(new c.CommandMessage("__form:inited__",{}),"*")})),window.addEventListener("message",(function(e){if(c){let t=e.data;if(c.detectIsCustomMessage(t)){let{name:e,value:a}=t.msg;"__iframe:ok__"===e&&(d=a)}}}));let g,_=null,{currentRoute:h,router:y}=m();h.query.path,g=null!=(a=h.query.storeName)?a:l,globalThis.getCachedPageControlModel=function(){return _};let v=null;o((()=>import("./ext.943b90d0.js").then((function(e){return e.k}))),["assets/ext.943b90d0.js","assets/ext.d9ad9e73.css","assets/index.872417fc.js","assets/index.71233784.css","assets/vendor.70e2a6e0.js","assets/CommonRender.d6009dc7.js","assets/nodes.a56b7126.js","assets/form.e330999e.js"]).then((e=>{v=e.useToolApi()}));let b=f({loading:!1}),w=new Map;k("formPage",{registerCom(e,t){w.set(e,t)}});let C=n({properties:{textarea_step:{type:String}},computed:{}},{onInited:function({storeControl:e}){C.commonLoadStep(o((()=>import("./Form2EditorConfig.24245ac0.js")),[]),"textarea_step",{async onMounted(e){let t=await C.dispatchRoot("GetStoreEvents",{storeName:g});_=t,C.setPartModel(e.name,"form2",null!=t?t:{})}})},extendContext:{},servicePrefix:"PageDemoForm2Service"});C=s(C),C=r(C);let E=C.setRef("wechatDialogRef"),T=C.setRef("vue2DialogRef"),x=null;globalThis.getPageCachedModel=function(){return _};let R=new Map;return C.setComEventHandler=function(e,t){R.set(e,t)},C.execComEventHandler=function(e,t){R.has(e)&&R.get(e)(t)},C.setEventHandler({"add:arr:common"(e){let{parts:t,partName:a,pathArr:l,process:o}=e,n=ZY.getObjPathFromPathArr(l);t[a].arrAppend(n)},async"load:file"(e){try{let e=await ZY_EXT.fileOpenJSON5();e.data&&(await C.dispatchRoot("SetStoreLocal",{storeName:g,data:e.data}),await ZY.sleep(300)),e.layout&&(await C.runRefMethod("layout","importToolsData",e.layout),await ZY.sleep(300),await C.runRefMethod("layout","saveCache2Storage",e.layout)),await ZY.sleep(300),location.reload()}catch(t){console.log(t)}},async"call:save"(e){function t(e){return"string"==typeof e?ZY.JSON5.parse(e):e}try{b.loading=!0;let e=[];w.forEach((function(t){t&&t.save&&e.push(new Promise((function(e,a){t.save().then((t=>{e(t)}))})))})),Promise.all(e).then((async e=>{let a=ZY.JSON5.parse(_.value),l=a.parts[0],o=ZY.JSON5.parse(l.drag_cached);t(l.metas);{let[e,n]=await ZY.awaitTo(v.saveJson(l.properties,_.name+".json5",{headers:{"X-Access-Token":d?d.token:""},data:{formName:_.name},newProps:ZY.JSON5.parse(l.properties),oldProps:o.oldProps}));if(e)return globalThis.ElMessage.error("保存表单失败 saveJson"),void(b.loading=!1);console.log("res",n),l.metas=ZY.JSON5.stringify({form_data:n}),await async function(e,a){_.value=ZY.JSON5.stringify(e);let l=i(e,e.name,{src:"comformscr2.twig"});_.def=l.init.def,_.metas=a.metas,console.log(a,_),await C.dispatchRoot("SetStoreLocal",{storeName:g,data:_}),window.parent.postMessage(new c.CommandMessage("form:save",{metas:t(a.metas),formName:_.name,form:a}),"*")}(a,l)}b.loading=!1}))}catch(a){console.log("JSON5 parse err",a,_)}},"call:save:file"(e){var t;let{partName:a,parts:l}=e,o=l[a].getModel(),n=u(o),s={data:n,date:Date.now()},r=null!=(t=n.name)?t:ZY.rid(6);ZY_EXT.saveJSONFile({data:s,fileName:r,prefix:"form2_",saveFun:(e,{file:t}={})=>ZY_EXT.saveStrUseFS(e,{extensions:[".json5"],fileName:t,type:"text/plain"})})},async"open:dialog"(e){C.getRef("wechatDialogRef").show()},async"open:vue2"(e){C.getRef("vue2DialogRef").show()},async"get:vue:file"(e){var t;let{model:a={}}=e,l=ZY.JSON5;ZY.lodash;const o=null!=(t=null==a?void 0:a.libPath)?t:"@/zform/zform";let n="__"+ZY.Time.formatDateTime(new Date,"YYYY-MM-DD__HH_mm_ss");if(_&&_.def){let e=_.name,t=l.parse(_.value).parts[0],a=new Map;console.log(_),function(){let n=_.def,s=l.stringify(n.parts[0]),r=document.getElementById("output-form-vue2-tpl").innerHTML,i=t.slots.map((e=>{let t={web:"",weapp:""};try{t=l.parse(e.value)}catch(o){}return`\n<template v-slot:${e.name}="scope">\n${a=t.web,a.replaceAll("@tap","@click")}\n</template>\n`;var a})),p=globalThis.twigRender(r,{ZFORM_RELATIVE_PATH:o,formComName:e,slots_str:i.join("\n"),json5_config:s,metas:_.metas});a.set(e+".vue",p)}(),globalThis.downloadFiles("vue2__"+e+n,a)}},async"get:xml:file"(e){var t;let{model:a={}}=e,l=ZY.JSON5,o=ZY.lodash;const n=null!=(t=null==a?void 0:a.libPath)?t:"../zform";let s="__"+ZY.Time.formatDateTime(new Date,"YYYY-MM-DD__HH_mm_ss");if(_&&_.def){let e=l.parse(_.value).parts[0],t=l.parse(e.properties);console.log(t);let a=S({handleProp({obj:e,s_path:a,path:n,ext:s}){let r=n[n.length-1],i=o.get(t,a);if(i.css){let t=[],a=l.parse(i.css);o.each(a.cached,(function(e,a){let l=`.cm-field--${r} `+a.replaceAll(":host","rich-text").replace("(","").replace(")","");t.push([l,ZY.CSS.parseObj(e,{split:";\n"}).trim()])})),e[r]=t.map((([e,t])=>t?`${e} {\n${t}\n}`:"")).filter((e=>e)).join("\n")}}}).run(t),r=Object.entries(a).map((e=>e[1])).join("\n"),i=_.def,m=p.getPartStrArr(i,p.renderWeappForm)[0],c=new Map,d=_.name,f=d+"-slots";!function(){let t=e.slots.map((e=>{let t={web:"",weapp:""};try{t=l.parse(e.value)}catch(a){}return`\n<template name="${e.name}">\n${t.weapp}\n</template>\n`})),a=globalThis.createParseComponentMan(document.getElementById("output-form-slot-com-tpl").innerHTML),o=a.get("template").content,s=globalThis.twigRender(o,{ZFORM_RELATIVE_PATH:n,formComName:d,slots_str:t.join("\n")});c.set(f+".wxml",s);let r=a.get("script").content;r=globalThis.twigRender(r,{ZFORM_RELATIVE_PATH:n,formComName:d}),c.set(f+".js",r);let i=a.get("config").content;c.set(f+".json",i)}(),function(){let e=globalThis.createParseComponentMan(document.getElementById("output-form-tpl").innerHTML),t=e.get("template").content,a=globalThis.twigRender(t,{ZFORM_RELATIVE_PATH:n,formComName:d,form_tpl:m.value});c.set(d+".wxml",a);let o=e.get("script").content;o=globalThis.twigRender(o,{ZFORM_RELATIVE_PATH:n,formComName:d,json5_config:l.stringify(i.parts[0])}),c.set(d+".js",o);let s=e.get("config").content;s=globalThis.twigRender(s,{ZFORM_RELATIVE_PATH:n,formComName:d,slot_com_name:f,cm_field_name:"cm-field"}),c.set(d+".json",s);let p=e.get("styles")[0].content,u=globalThis.twigRender(p,{css:r.trim(),ZFORM_RELATIVE_PATH:n,formComName:d});c.set(d+".wxss",u)}(),console.log(_,e),globalThis.downloadFiles("mp-weixin__"+d+s,c)}},"add:part"(e){let{parts:t,partName:a,selfpath:l,process:o}=e;t[a].arrAppend(l)},"add:forms"(e){let{parts:t,partName:a,selfpath:l,process:o}=e;t[a].arrAppend(l)},async"forms:select-form"(e){let{value:t,scope:a}=e,{parts:l,partName:o,selfpath:n,process:s}=x,r={name:t.label,value:t.value};l[o].arrAppend(n,r),await ZY.sleep(300),C.webComponentRef.toggleDialog("form-mana-dialog")},async"load:single:layoutSlotArr"(e){let{parts:t,partName:a,selfpath:l}=e;try{let e=(await FormsLayout.readFile())[0].value,o=`${l}`;t[a].setModelByPath(o,e)}catch(o){console.log(o)}},"open:layoutSlotArr"(e){x=e,C.refsManager.runCom("form-layout-select","load"),C.webComponentRef.toggleDialog("form-layout-dialog")},async"save:single:layoutSlotArr"(e){let{parts:t,partName:a,selfpath:l}=e,o=u(t[a].getModelByPath(l));await FormsLayout.saveCache2File([{name:o.name,value:o}],{fileName:o.name})},"submit:form"(e){let{scope:t,parts:a}=e;a[t.name].getModel(),t.process,C.store.model.textarea_step},"model:update:all"(e){let{model:t,key:a,newVal:l,config:o}=e;o.process===C.store.model.textarea_step?Object.entries(t).forEach((([e,a])=>{_[e]=t[e]})):C.execComEventHandler("model:update:all",e)}}),{store:C.store,vue2DialogRef:T,wechatDialogRef:E,state:b,onClosed:function(){console.log("onClosed")},page:C,allDef:C.defMap}}}),D={key:0,class:"page-form2"},O=M("h3",null,"事件",-1),H=M("h3",null,"片段",-1),z=M("h3",null,"表单",-1),F={class:"mao-bo-li",style:{position:"sticky",top:"0","z-index":"121",padding:"var(--z-size-10) var(--z-size-10)"}},L=b("保存"),J=b("保存本地文件"),I=b("加载本地文件"),V=b("导出小程序文件"),$=b("导出vue2文件"),B={key:0},X={key:1};j.render=function(e,t,a,l,o,n){const s=g("wechat-export-dialog"),r=g("vue2-export-dialog"),i=g("el-button"),p=g("el-space"),m=g("el-col"),c=g("el-popconfirm"),d=g("HttpComponent"),f=C("loading");return e.page.inited?E((_(),T("div",D,[v(s,{ref:e.wechatDialogRef,page:e.page,onSubmit:t[0]||(t[0]=t=>e.page.callEvent("get:xml:file",t))},null,8,["page"]),v(r,{ref:e.vue2DialogRef,page:e.page,onSubmit:t[1]||(t[1]=t=>e.page.callEvent("get:vue:file",t))},null,8,["page"]),e.store.model.textarea_step?(_(),h(d,{key:0,defs:e.allDef,is:e.store.model.textarea_step,debug:!1,"onDragxml:closed":e.onClosed},{array_beforebegin:y((t=>["events"===t.key?(_(),h(p,{key:0,align:"middle"},{default:y((()=>[O,v(i,{size:"small",onClick:a=>e.page.callEvent("add:events",t)},{default:y((()=>[b("添加"+x(t.label),1)])),_:2},1032,["onClick"]),v(i,{size:"small",onClick:a=>e.page.callEvent(`open:${t.key}`,t)},{default:y((()=>[b("打开"+x(t.label)+"管理",1)])),_:2},1032,["onClick"])])),_:2},1024)):"layoutSlotArr"===t.key?(_(),h(p,{key:1,align:"middle"},{default:y((()=>[H,v(i,{size:"small",onClick:a=>e.page.callEvent("add:arr:common",t)},{default:y((()=>[b("添加"+x(t.label),1)])),_:2},1032,["onClick"]),v(i,{size:"small",onClick:a=>e.page.callEvent(`open:${t.key}`,t)},{default:y((()=>[b("打开"+x(t.label)+"管理",1)])),_:2},1032,["onClick"])])),_:2},1024)):"forms"===t.key?(_(),h(p,{key:2,align:"middle"},{default:y((()=>[z,v(i,{size:"small",onClick:a=>e.page.callEvent("add:forms",t)},{default:y((()=>[b("添加"+x(t.label),1)])),_:2},1032,["onClick"]),v(i,{size:"small",onClick:a=>e.page.callEvent("open:forms",t)},{default:y((()=>[b("打开"+x(t.label)+"管理",1)])),_:2},1032,["onClick"])])),_:2},1024)):(_(),T(R,{key:3},[],64))])),array_afterbegin:y((e=>["events"!==e.key&&"layoutSlotArr"!==e.key&&"forms"!==e.key?(_(),h(m,{key:0},{default:y((()=>[v(p,{align:"middle"},{default:y((()=>[M("h3",null,x(e.selfpath),1)])),_:2},1024)])),_:2},1024)):N("",!0)])),array_con_beforeend:y((t=>[v(p,{wrap:""},{default:y((()=>[v(c,{title:"确定删除吗？",onConfirm:a=>e.page.callEvent("remove:events",t)},{reference:y((()=>[v(i,{type:"danger",size:"small"},{default:y((()=>[b("删除"+x(t.label),1)])),_:2},1024)])),_:2},1032,["onConfirm"]),"forms"===t.key?(_(),T(R,{key:0},[v(i,{size:"small",onClick:a=>e.page.callEvent(`save:single:${t.key}`,t)},{default:y((()=>[b("保存"+x(t.label)+"文件",1)])),_:2},1032,["onClick"]),v(i,{size:"small",onClick:a=>e.page.callEvent(`load:single:${t.key}`,t)},{default:y((()=>[b("导入"+x(t.label)+"文件",1)])),_:2},1032,["onClick"])],64)):N("",!0),"events"===t.key?(_(),h(i,{key:1,size:"small",onClick:a=>e.page.callEvent(`save:single:${t.key}`,t)},{default:y((()=>[b("保存"+x(t.label)+"文件",1)])),_:2},1032,["onClick"])):N("",!0),"layoutSlotArr"===t.key?(_(),T(R,{key:2},[v(i,{size:"small",onClick:a=>e.page.callEvent(`save:single:${t.key}`,t)},{default:y((()=>[b("保存"+x(t.label)+"文件",1)])),_:2},1032,["onClick"]),v(i,{size:"small",onClick:a=>e.page.callEvent(`load:single:${t.key}`,t)},{default:y((()=>[b("导入"+x(t.label)+"文件",1)])),_:2},1032,["onClick"])],64)):N("",!0)])),_:2},1024)])),form_beforebegin:y((a=>[M("div",F,[v(p,null,{default:y((()=>[v(i,{type:"primary",onClick:t=>e.page.callEvent("call:save",a)},{default:y((()=>[L])),_:2},1032,["onClick"]),v(i,{type:"primary",onClick:t=>e.page.callEvent("call:save:file",a)},{default:y((()=>[J])),_:2},1032,["onClick"]),v(i,{type:"primary",onClick:t[2]||(t[2]=t=>e.page.callEvent("load:file"))},{default:y((()=>[I])),_:1}),v(i,{type:"primary",onClick:t[3]||(t[3]=t=>e.page.callEvent("open:dialog"))},{default:y((()=>[V])),_:1}),v(i,{type:"primary",onClick:t[4]||(t[4]=t=>e.page.callEvent("open:vue2"))},{default:y((()=>[$])),_:1})])),_:2},1024)])])),prop_beforeend:y((e=>["props"===e.selfpath?(_(),T(R,{key:0},[],64)):"name"===e.selfpath?(_(),T(R,{key:1},[],64)):(_(),T(R,{key:2},[],64))])),prop_afterbegin:y((e=>["props"===e.selfpath?(_(),T("h3",B,"页面变量")):"onInited"===e.selfpath?(_(),T("h3",X,"当初始化")):(_(),T(R,{key:2},[],64))])),_:1},8,["defs","is","onDragxml:closed"])):N("",!0)],512)),[[f,e.state.loading]]):N("",!0)};export{j as default};
